suite: test CSI Secrets Store volume functionality
templates:
  - templates/aggregator-deploy.yaml
  - templates/agent-deploy.yaml
  - templates/webhook-deploy.yaml
tests:
  - it: should support CSI Secrets Store volume for API key in aggregator deployment
    set:
      clusterName: "test-cluster"
      cloudAccountId: "123456789"
      region: "us-east-1"
      # Use existing secret name to satisfy validation
      existingSecretName: "cloudzero-api-key-secret"
      apiKey: null
      extraVolumes:
        - name: cloudzero-api-key-csi
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "cloudzero-api-key-spc"
      extraVolumeMounts:
        - name: cloudzero-api-key-csi
          mountPath: /etc/csi-secrets/
          readOnly: true
    asserts:
      - hasDocuments:
          count: 1
        template: templates/aggregator-deploy.yaml
      - isKind:
          of: Deployment
        template: templates/aggregator-deploy.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: cloudzero-api-key-csi
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "cloudzero-api-key-spc"
        template: templates/aggregator-deploy.yaml
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: cloudzero-api-key-csi
            mountPath: /etc/csi-secrets/
            readOnly: true
        template: templates/aggregator-deploy.yaml
      - contains:
          path: spec.template.spec.containers[1].volumeMounts
          content:
            name: cloudzero-api-key-csi
            mountPath: /etc/csi-secrets/
            readOnly: true
        template: templates/aggregator-deploy.yaml

  - it: should support CSI Secrets Store volume for API key in agent deployment
    set:
      clusterName: "test-cluster"
      cloudAccountId: "123456789"
      region: "us-east-1"
      existingSecretName: "cloudzero-api-key-secret"
      apiKey: null
      extraVolumes:
        - name: cloudzero-api-key-csi
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "cloudzero-api-key-spc"
      extraVolumeMounts:
        - name: cloudzero-api-key-csi
          mountPath: /etc/csi-secrets/
          readOnly: true
    asserts:
      - hasDocuments:
          count: 1
        template: templates/agent-deploy.yaml
      - isKind:
          of: Deployment
        template: templates/agent-deploy.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: cloudzero-api-key-csi
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "cloudzero-api-key-spc"
        template: templates/agent-deploy.yaml
      - contains:
          path: spec.template.spec.containers[1].volumeMounts
          content:
            name: cloudzero-api-key-csi
            mountPath: /etc/csi-secrets/
            readOnly: true
        template: templates/agent-deploy.yaml

  - it: should support CSI Secrets Store volume for API key in webhook deployment
    set:
      clusterName: "test-cluster"
      cloudAccountId: "123456789"
      region: "us-east-1"
      existingSecretName: "cloudzero-api-key-secret"
      apiKey: null
      extraVolumes:
        - name: cloudzero-api-key-csi
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "cloudzero-api-key-spc"
      extraVolumeMounts:
        - name: cloudzero-api-key-csi
          mountPath: /etc/csi-secrets/
          readOnly: true
    asserts:
      - hasDocuments:
          count: 1
        template: templates/webhook-deploy.yaml
      - isKind:
          of: Deployment
        template: templates/webhook-deploy.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: cloudzero-api-key-csi
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "cloudzero-api-key-spc"
        template: templates/webhook-deploy.yaml
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: cloudzero-api-key-csi
            mountPath: /etc/csi-secrets/
            readOnly: true
        template: templates/webhook-deploy.yaml

  - it: should support CSI Secrets Store volume with AWS provider
    set:
      clusterName: "test-cluster"
      cloudAccountId: "123456789"
      region: "us-east-1"
      existingSecretName: "cloudzero-api-key-secret"
      apiKey: null
      extraVolumes:
        - name: aws-secrets-csi
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "aws-secrets-provider"
      extraVolumeMounts:
        - name: aws-secrets-csi
          mountPath: /etc/aws-secrets/
          readOnly: true
    asserts:
      - hasDocuments:
          count: 1
        template: templates/aggregator-deploy.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: aws-secrets-csi
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "aws-secrets-provider"
        template: templates/aggregator-deploy.yaml

  - it: should support CSI Secrets Store volume with Azure provider
    set:
      clusterName: "test-cluster"
      cloudAccountId: "123456789"
      region: "eastus"
      existingSecretName: "cloudzero-api-key-secret"
      apiKey: null
      extraVolumes:
        - name: azure-secrets-csi
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "azure-keyvault-provider"
      extraVolumeMounts:
        - name: azure-secrets-csi
          mountPath: /etc/azure-secrets/
          readOnly: true
    asserts:
      - hasDocuments:
          count: 1
        template: templates/aggregator-deploy.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: azure-secrets-csi
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "azure-keyvault-provider"
        template: templates/aggregator-deploy.yaml

  - it: should support CSI Secrets Store volume with GCP provider
    set:
      clusterName: "test-cluster"
      cloudAccountId: "123456789"
      region: "us-central1"
      existingSecretName: "cloudzero-api-key-secret"
      apiKey: null
      extraVolumes:
        - name: gcp-secrets-csi
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "gcp-secret-manager-provider"
      extraVolumeMounts:
        - name: gcp-secrets-csi
          mountPath: /etc/gcp-secrets/
          readOnly: true
    asserts:
      - hasDocuments:
          count: 1
        template: templates/aggregator-deploy.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: gcp-secrets-csi
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "gcp-secret-manager-provider"
        template: templates/aggregator-deploy.yaml

  - it: should support multiple CSI Secrets Store volumes
    set:
      clusterName: "test-cluster"
      cloudAccountId: "123456789"
      region: "us-east-1"
      existingSecretName: "cloudzero-api-key-secret"
      apiKey: null
      extraVolumes:
        - name: cloudzero-api-key-csi
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "cloudzero-api-key-spc"
        - name: additional-secrets-csi
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "additional-secrets-spc"
      extraVolumeMounts:
        - name: cloudzero-api-key-csi
          mountPath: /etc/csi-secrets/
          readOnly: true
        - name: additional-secrets-csi
          mountPath: /etc/additional-secrets/
          readOnly: true
    asserts:
      - hasDocuments:
          count: 1
        template: templates/aggregator-deploy.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: cloudzero-api-key-csi
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "cloudzero-api-key-spc"
        template: templates/aggregator-deploy.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: additional-secrets-csi
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "additional-secrets-spc"
        template: templates/aggregator-deploy.yaml

  - it: should support CSI Secrets Store volume with nodePublishSecretRef
    set:
      clusterName: "test-cluster"
      cloudAccountId: "123456789"
      region: "us-east-1"
      existingSecretName: "cloudzero-api-key-secret"
      apiKey: null
      extraVolumes:
        - name: cloudzero-api-key-csi
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "cloudzero-api-key-spc"
            nodePublishSecretRef:
              name: secrets-store-creds
      extraVolumeMounts:
        - name: cloudzero-api-key-csi
          mountPath: /etc/csi-secrets/
          readOnly: true
    asserts:
      - hasDocuments:
          count: 1
        template: templates/aggregator-deploy.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: cloudzero-api-key-csi
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "cloudzero-api-key-spc"
              nodePublishSecretRef:
                name: secrets-store-creds
        template: templates/aggregator-deploy.yaml

  - it: should include both default secret volume and CSI volume when both are configured
    set:
      clusterName: "test-cluster"
      cloudAccountId: "123456789"
      region: "us-east-1"
      existingSecretName: "cloudzero-api-key-secret"
      apiKey: null
      extraVolumes:
        - name: additional-csi-secrets
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "additional-secrets-spc"
      extraVolumeMounts:
        - name: additional-csi-secrets
          mountPath: /etc/additional-secrets/
          readOnly: true
    asserts:
      - hasDocuments:
          count: 1
        template: templates/aggregator-deploy.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: cloudzero-api-key
            secret:
              secretName: cloudzero-api-key-secret
        template: templates/aggregator-deploy.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: additional-csi-secrets
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "additional-secrets-spc"
        template: templates/aggregator-deploy.yaml
